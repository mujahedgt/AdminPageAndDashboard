@model List<AdminPageAndDashboard.Models.User>
@{
    ViewData["Title"] = "User Management";
    var roles = ViewBag.Roles as List<AdminPageAndDashboard.Models.Role> ?? new List<AdminPageAndDashboard.Models.Role>();
    var currentUserId = Context.Session.GetInt32("UserId") ?? 0;
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-users me-2"></i> User Management
        </h1>
        <small class="text-muted">Manage system users and their permissions</small>
    </div>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUserModal">
        <i class="fas fa-user-plus me-2"></i> Add User
    </button>
</div>

<!-- Alerts -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Users Table -->
<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Full Name</th>
                        <th>Roles</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model == null || Model.Count == 0)
                    {
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="fas fa-inbox fa-2x text-muted mb-2" style="display: block;"></i>
                                <p class="text-muted mb-0">No users found</p>
                            </td>
                        </tr>
                    }
                    else
                    {
                        foreach (var user in Model)
                        {
                            var roleNames = new List<string>();
                            if (user.UserRoles != null)
                            {
                                foreach (var ur in user.UserRoles)
                                {
                                    if (ur.Role?.RoleName != null)
                                        roleNames.Add(ur.Role.RoleName);
                                }
                            }

                            <tr>
                                <td>
                                    <strong>@user.Username</strong>
                                </td>
                                <td>
                                    <a href="mailto:@user.Email" class="text-decoration-none">
                                        @user.Email
                                    </a>
                                </td>
                                <td>@user.FullName</td>
                                <td>
                                    @if (roleNames.Any())
                                    {
                                        foreach (var role in roleNames)
                                        {
                                            var badgeClass = role switch
                                            {
                                                "Admin" => "bg-danger",
                                                "Operator" => "bg-warning",
                                                "Viewer" => "bg-info",
                                                _ => "bg-secondary"
                                            };
                                            <span class="badge @badgeClass me-1">@role</span>
                                        }
                                    }
                                    else
                                    {
                                        <em class="text-muted">None</em>
                                    }
                                </td>
                                <td>
                                    <span class="badge @(user.IsActive ? "bg-success" : "bg-secondary")">
                                        @(user.IsActive ? "Active" : "Disabled")
                                    </span>
                                </td>
                                <td class="text-muted small">
                                    @(user.LastLogin?.ToString("g") ?? "Never")
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button"
                                                class="btn btn-sm btn-outline-warning"
                                                title="Edit user"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editUserModal"
                                                data-user-id="@user.Id"
                                                data-username="@user.Username"
                                                data-email="@user.Email"
                                                data-fullname="@user.FullName"
                                                data-isactive="@user.IsActive"
                                                onclick="loadEditModal(event)">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        @if (user.Id != currentUserId)
                                        {
                                            <form asp-action="Delete" asp-controller="Users" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                                <input type="hidden" name="id" value="@user.Id" />
                                                @Html.AntiForgeryToken()
                                                <button type="submit"
                                                        class="btn btn-sm btn-outline-danger"
                                                        title="Delete user">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-secondary"
                                                    title="Cannot delete your own account"
                                                    disabled>
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="Create" method="post" id="createUserForm" novalidate>
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title" id="createUserModalLabel">
                        <i class="fas fa-user-plus me-2"></i> Create New User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form Fields -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-user me-1"></i> Username
                            </label>
                            <input name="username"
                                   class="form-control"
                                   placeholder="Enter username"
                                   required
                                   minlength="3"
                                   maxlength="50" />
                            <div class="invalid-feedback">Username is required (3-50 characters)</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-envelope me-1"></i> Email
                            </label>
                            <input name="email"
                                   type="email"
                                   class="form-control"
                                   placeholder="Enter email"
                                   required />
                            <div class="invalid-feedback">Valid email is required</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-id-card me-1"></i> Full Name
                            </label>
                            <input name="fullName"
                                   class="form-control"
                                   placeholder="Enter full name"
                                   required
                                   minlength="3"
                                   maxlength="100" />
                            <div class="invalid-feedback">Full name is required</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-lock me-1"></i> Password
                            </label>
                            <input name="password"
                                   type="password"
                                   class="form-control"
                                   placeholder="Enter password"
                                   required
                                   minlength="6" />
                            <div class="invalid-feedback">Password is required (min 6 characters)</div>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Role Selection - DYNAMIC -->
                    <label class="form-label mb-3">
                        <i class="fas fa-shield-alt me-1"></i> <strong>Assign Roles</strong>
                    </label>
                    <div class="row g-3">
                        @if (roles.Any())
                        {
                            @foreach (var role in roles)
                            {
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="roleIds"
                                               value="@role.Id"
                                               id="role@(role.Id)" />
                                        <label class="form-check-label" for="role@(role.Id)">
                                            <strong>@role.RoleName</strong>
                                            <small class="d-block text-muted">@role.Description</small>
                                        </label>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No roles available. Please add roles to the system.
                                </div>
                            </div>
                        }
                    </div>
                    <small class="text-danger d-block mt-2">
                        <i class="fas fa-info-circle"></i> At least one role must be selected
                    </small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-check me-1"></i> Create User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="Edit" method="post" id="editUserForm" novalidate>
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">
                        <i class="fas fa-user-edit me-2"></i> Edit User
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="id" id="editUserId" />

                    <!-- Form Fields -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-user me-1"></i> Username
                            </label>
                            <input name="username"
                                   id="editUsername"
                                   class="form-control"
                                   placeholder="Enter username"
                                   required
                                   minlength="3"
                                   maxlength="50"
                                   disabled />
                            <small class="text-muted">Username cannot be changed</small>
                            <div class="invalid-feedback">Username is required</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-envelope me-1"></i> Email
                            </label>
                            <input name="email"
                                   id="editEmail"
                                   type="email"
                                   class="form-control"
                                   placeholder="Enter email"
                                   required />
                            <div class="invalid-feedback">Valid email is required</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-id-card me-1"></i> Full Name
                            </label>
                            <input name="fullName"
                                   id="editFullName"
                                   class="form-control"
                                   placeholder="Enter full name"
                                   required
                                   minlength="3"
                                   maxlength="100" />
                            <div class="invalid-feedback">Full name is required</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-toggle-on me-1"></i> Status
                            </label>
                            <select name="isActive" id="editIsActive" class="form-select" required>
                                <option value="true">Active</option>
                                <option value="false">Disabled</option>
                            </select>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <!-- Role Selection -->
                    <label class="form-label mb-3">
                        <i class="fas fa-shield-alt me-1"></i> <strong>Assign Roles</strong>
                    </label>
                    <div class="row g-3" id="editRolesContainer">
                        @if (roles.Any())
                        {
                            @foreach (var role in roles)
                            {
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input edit-role"
                                               type="checkbox"
                                               name="roleIds"
                                               value="@role.Id"
                                               id="editRole@(role.Id)" />
                                        <label class="form-check-label" for="editRole@(role.Id)">
                                            <strong>@role.RoleName</strong>
                                            <small class="d-block text-muted">@role.Description</small>
                                        </label>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation/dist/additional-methods.min.js"></script>
    <script>
        function loadEditModal(event) {
            const button = event.currentTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            const email = button.getAttribute('data-email');
            const fullname = button.getAttribute('data-fullname');
            const isactive = button.getAttribute('data-isactive');

            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editFullName').value = fullname;
            document.getElementById('editIsActive').value = isactive;

            // Uncheck all roles first
            document.querySelectorAll('.edit-role').forEach(checkbox => {
                checkbox.checked = false;
            });

            // Load user's roles via AJAX
            fetch(`/Users/GetUserRoles?userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.roleIds) {
                        data.roleIds.forEach(roleId => {
                            const checkbox = document.getElementById(`editRole${roleId}`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading roles:', error));
        }

        $(document).ready(function() {
            // Reset form when modals are hidden
            $('#createUserModal').on('hidden.bs.modal', function() {
                $('#createUserForm')[0].reset();
                $('#createUserForm').removeClass('was-validated');
                $('#createUserForm').find('.invalid-feedback').hide();
            });

            $('#editUserModal').on('hidden.bs.modal', function() {
                $('#editUserForm')[0].reset();
                $('#editUserForm').removeClass('was-validated');
            });

            // Validate create form
            $("#createUserForm").validate({
                rules: {
                    username: { required: true, minlength: 3, maxlength: 50 },
                    email: { required: true, email: true },
                    fullName: { required: true, minlength: 3, maxlength: 100 },
                    password: { required: true, minlength: 6 }
                },
                messages: {
                    username: {
                        required: "Username is required",
                        minlength: "Username must be at least 3 characters"
                    },
                    email: {
                        required: "Email is required",
                        email: "Please enter a valid email"
                    },
                    fullName: {
                        required: "Full name is required",
                        minlength: "Full name must be at least 3 characters"
                    },
                    password: {
                        required: "Password is required",
                        minlength: "Password must be at least 6 characters"
                    }
                },
                highlight: function(element) {
                    $(element).addClass('is-invalid').removeClass('is-valid');
                    $(element).closest('.col-md-6').find('.invalid-feedback').show();
                },
                unhighlight: function(element) {
                    $(element).removeClass('is-invalid').addClass('is-valid');
                    $(element).closest('.col-md-6').find('.invalid-feedback').hide();
                },
                submitHandler: function(form) {
                    if ($('input[name="roleIds"]:checked').length === 0) {
                        alert('Please select at least one role');
                        return false;
                    }
                    $(form).off('submit').submit();
                }
            });

            // Validate edit form
            $("#editUserForm").validate({
                rules: {
                    email: { required: true, email: true },
                    fullName: { required: true, minlength: 3, maxlength: 100 }
                },
                submitHandler: function(form) {
                    if ($('input.edit-role:checked').length === 0) {
                        alert('Please select at least one role');
                        return false;
                    }
                    $(form).off('submit').submit();
                }
            });
        });
    </script>
}